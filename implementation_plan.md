


























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































# Implementation Plan - Regex Refinement

## Goal Description
Refine the Regex logic in `ParsingTool/parsing/domestic_zapi/pipeline.py` to improve the accuracy of data extraction, specifically for **SSCC** and **Variety** fields. The current patterns are too loose, causing "shifted" columns and truncated data.

## User Review Required
> [!IMPORTANT]
> **Variety Extraction Risk**: I am proposing to **disable the broad 2-4 letter Grade fallback**.
> Currently, any 2-4 letter uppercase word (like "BIG", "NEW", "ABC") is treated as a "Grade", which causes the "Variety" description to be cut off at that word.
> **Change**: We will only detect Grades that explicitly match our known list (SSR, Supr, XNo1, etc.).
> **Impact**: If there are valid Grades that are NOT in our known list, they will now be part of the "Variety" string instead of being extracted as "Grade". This is safer than truncating the Variety.

## Proposed Changes

### `ParsingTool/parsing/domestic_zapi/pipeline.py`

#### [MODIFY] `SSCC_RE`
**Current**: `r"\b(\d{18,20})\b"` (Matches 18 to 20 digits)
**New**: `r"\b(\d{18})\b"`
**Reason**: SSCC codes are strictly 18 digits (GS1 standard). Allowing 20 digits risks capturing concatenated numbers or other identifiers, causing data alignment issues.

#### [MODIFY] `GRADE_TOKEN_RE`
**Current**: `r"\b([A-Z]{2,4})\b"` (Matches ANY 2-4 letter uppercase word)
**New**: `r"\b(SSR|SUPR|XNO1|NP)\b"` (Matches ONLY specific known grades)
**Reason**: The current pattern is too aggressive. It matches words like "NON" or "THE" inside a product description, using them as a split point. This results in the "Variety" field being truncated (e.g., "NONPAREIL" becomes Variety="" and Grade="NON").
**Implementation**: We will update the `grade_patterns` list to include all known grades and remove the generic `GRADE_TOKEN_RE` fallback usage.

## Verification Plan

### Manual Verification
1.  **Run the GUI**: Open the Parsing Tool.
2.  **Process File**: Run the "Domestic ZAPI" mode on your sample PDF.
3.  **Check CSV**: Open `domestic_sscc_combined.csv`.
    *   **SSCC Column**: Verify all values are exactly 18 digits.
    *   **Variety Column**: Check that descriptions are full and not cut off (e.g., "NONPAREIL SUPREME" should be the Variety, or "NONPAREIL" if "SUPREME" is the Grade).
    *   **Grade Column**: Verify it only contains valid grades (SSR, Supr, etc.) and not random words.
